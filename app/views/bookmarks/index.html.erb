<%# ── Bookmarks page ──────────────────────────────────────── %>
<div class="mb-6 border-b border-gray-200 pb-6 flex items-end justify-between gap-4">
  <div>
    <p class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-1">Saved</p>
    <h1 class="font-serif text-4xl font-bold">Bookmarks</h1>
  </div>
  <div class="flex items-center gap-4 mb-1">
    <% if @articles&.any? %>
      <span class="text-sm text-gray-400"><%= pluralize(@articles.total_count, "saved article") %></span>
      <button id="clear-bookmarks-btn"
              class="text-xs text-red-400 hover:text-red-600 border border-red-200 hover:border-red-400 px-3 py-1.5 transition-colors">
        Clear all
      </button>
    <% end %>
  </div>
</div>

<%# ── No params yet: JS reads localStorage and redirects ── %>
<% if @articles.nil? %>
  <div id="bm-resolve" class="flex justify-center py-20">
    <svg class="animate-spin w-6 h-6 text-red-400" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
    </svg>
  </div>
  <script>
    (function () {
      var KEY = 'magazine_bookmarks';
      function getIds() { try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch (e) { return []; } }

      var ids = getIds();
      if (ids.length) {
        window.location.replace('/bookmarks?ids=' + ids.join(','));
      } else {
        document.getElementById('bm-resolve').innerHTML =
          '<div class="py-20 text-center border border-dashed border-gray-300">' +
            '<svg class="w-12 h-12 text-gray-200 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">' +
              '<path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>' +
            '</svg>' +
            '<p class="text-gray-400 text-sm font-medium mb-1">No saved articles yet.</p>' +
            '<p class="text-gray-400 text-xs mb-6">Click the bookmark icon on any article to save it here.</p>' +
            '<a href="/articles" class="text-sm font-semibold px-5 py-2 bg-red-500 text-white hover:bg-red-600 transition-colors">Browse articles</a>' +
          '</div>';
      }
    }());
  </script>

<%# ── Articles found or empty ── %>
<% else %>
  <%= render "shared/article_grid", articles: @articles, bookmark_mode: true %>
<% end %>

<%# ── Clear-all confirmation dialog ── %>
<div id="clear-dialog"
     style="display:none"
     class="fixed inset-0 z-[300] flex items-center justify-center px-4">
  <div id="clear-dialog-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  <div class="relative bg-white w-full max-w-sm shadow-2xl p-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="flex items-center justify-center w-10 h-10 rounded-full bg-red-100 shrink-0">
        <svg class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
      </div>
      <div>
        <h3 class="text-base font-bold text-gray-900">Clear all bookmarks?</h3>
        <p class="text-sm text-gray-500 mt-0.5">This will remove all your saved articles. This action cannot be undone.</p>
      </div>
    </div>
    <div class="flex justify-end gap-3 mt-6">
      <button id="clear-dialog-cancel"
              class="px-4 py-2 text-sm font-semibold text-gray-600 border border-gray-200 hover:bg-gray-50 transition-colors">
        Cancel
      </button>
      <button id="clear-dialog-confirm"
              class="px-4 py-2 text-sm font-semibold text-white bg-red-500 hover:bg-red-600 transition-colors">
        Clear all
      </button>
    </div>
  </div>
</div>

<script>
(function () {
  var KEY = 'magazine_bookmarks';
  function getIds()      { try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch (e) { return []; } }
  function setIds(ids)   { localStorage.setItem(KEY, JSON.stringify(ids)); }
  function clearIds()    { localStorage.removeItem(KEY); }
  function bookmarksUrl(ids) {
    if (!ids.length) return '/bookmarks';
    return '/bookmarks?ids=' + ids.join(',');
  }

  document.addEventListener('turbo:load', function () {
    if (window.location.search) history.replaceState(null, '', '/bookmarks');

    var lsIds = getIds();

    <%# Remove individual bookmark — fade out, collapse, remove from DOM %>
    document.querySelectorAll('.bookmark-remove-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var id   = parseInt(btn.dataset.id, 10);
        var card = btn.closest('article');

        // Fade out
        card.style.transition = 'opacity 0.35s ease';
        card.style.opacity    = '0';

        var newIds = lsIds.filter(function (i) { return i !== id; });
        lsIds = newIds;
        setIds(newIds);

        setTimeout(function () {
          // Collapse the card's space smoothly
          var h = card.offsetHeight;
          card.style.transition = 'height 0.25s ease, margin 0.25s ease, padding 0.25s ease';
          card.style.overflow   = 'hidden';
          card.style.height     = h + 'px';
          card.offsetHeight; // force reflow
          card.style.height        = '0';
          card.style.marginTop     = '0';
          card.style.marginBottom  = '0';
          card.style.paddingTop    = '0';
          card.style.paddingBottom = '0';

          setTimeout(function () {
            card.remove();
            if (document.querySelectorAll('.bookmark-remove-btn').length === 0) {
              window.location.replace('/bookmarks');
            }
          }, 260);
        }, 350);
      });
    });

    <%# Clear all dialog %>
    var clearBtn = document.getElementById('clear-bookmarks-btn');
    var dialog   = document.getElementById('clear-dialog');
    if (clearBtn) {
      clearBtn.onclick = function () { dialog.style.display = 'flex'; };
    }
    document.getElementById('clear-dialog-cancel').onclick   = function () { dialog.style.display = 'none'; };
    document.getElementById('clear-dialog-backdrop').onclick = function () { dialog.style.display = 'none'; };
    document.getElementById('clear-dialog-confirm').onclick  = function () {
      clearIds();
      window.location.replace('/bookmarks');
    };
  });
}());
</script>
