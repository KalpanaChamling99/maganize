<%= form_with(model: [:admin, article], multipart: true, class: "space-y-8") do |form| %>

  <% if article.errors.any? %>
    <div class="bg-red-50 border border-red-200 px-5 py-4">
      <p class="text-sm font-semibold text-red-700 mb-2">
        <%= pluralize(article.errors.count, "error") %> prevented this article from being saved:
      </p>
      <ul class="list-disc list-inside text-sm text-red-600 space-y-1">
        <% article.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# Title %>
  <div>
    <%= form.label :title, "Title", class: "block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2" %>
    <%= form.text_field :title,
      placeholder: "Enter article title…",
      class: "w-full font-serif text-2xl font-bold border-0 border-b-2 border-gray-200 focus:border-gray-900 focus:outline-none focus:ring-0 py-2 px-0 placeholder-gray-300 bg-transparent transition-colors" %>
  </div>

  <%# Excerpt %>
  <div>
    <%= form.label :excerpt, "Excerpt", class: "block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2" %>
    <%= form.text_area :excerpt, rows: 3,
      placeholder: "Short summary shown on cards and listings…",
      class: "w-full border border-gray-200 focus:border-gray-900 focus:outline-none focus:ring-0 p-3 text-sm leading-relaxed placeholder-gray-300 resize-none transition-colors" %>
  </div>

  <%# Body %>
  <div>
    <%= form.label :body, "Body", class: "block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2" %>
    <%= form.text_area :body, rows: 18,
      placeholder: "Write your article here…",
      class: "w-full border border-gray-200 focus:border-gray-900 focus:outline-none focus:ring-0 p-4 text-sm leading-relaxed placeholder-gray-300 resize-y transition-colors font-mono" %>
  </div>

  <%# Cover Image %>
  <div>
    <p class="block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2">Cover Image</p>
    <% if article.persisted? && article.cover_image.attached? %>
      <div class="mb-3">
        <%= image_tag article.cover_image, class: "h-40 w-auto object-cover border border-gray-200" %>
        <p class="text-xs text-gray-400 mt-1">Current image — upload a new one to replace</p>
      </div>
    <% end %>
    <label class="flex flex-col items-center justify-center border-2 border-dashed border-gray-200 hover:border-gray-400 transition-colors cursor-pointer p-8 text-center bg-white"
           id="image-drop-zone">
      <%= form.file_field :cover_image, accept: "image/*",
        class: "sr-only", id: "cover_image_input", onchange: "previewImage(event)" %>
      <div id="image-preview" class="hidden mb-4">
        <img id="preview-img" src="" alt="Preview" class="h-40 w-auto object-cover mx-auto">
      </div>
      <div id="upload-prompt">
        <svg class="mx-auto h-10 w-10 text-gray-300 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        <p class="text-sm text-gray-500">Click or drag and drop to upload</p>
        <p class="text-xs text-gray-400 mt-1">PNG, JPG, WEBP — max 10MB</p>
      </div>
    </label>
  </div>

  <%# Gallery Images %>
  <div>
    <p class="block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2">Gallery Images</p>

    <%# Existing images %>
    <% if article.persisted? && article.images.attached? %>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mb-4">
        <% article.images.each do |image| %>
          <div class="relative group border border-gray-200 overflow-hidden">
            <%= image_tag image, class: "w-full h-28 object-cover" %>
            <%= link_to purge_image_admin_article_path(article, image_id: image.id),
              class: "absolute top-1 right-1 bg-white border border-gray-200 text-gray-500 hover:text-red-600 hover:border-red-300 transition-colors p-1 opacity-0 group-hover:opacity-100",
              data: { turbo_method: :delete, turbo_confirm: "Remove this image?" } do %>
              <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <%# Upload new images %>
    <label class="flex flex-col items-center justify-center border-2 border-dashed border-gray-200 hover:border-gray-400 transition-colors cursor-pointer p-8 text-center bg-white"
           id="gallery-drop-zone">
      <%= form.file_field :images, multiple: true, name: "article[images][]", accept: "image/*",
        class: "sr-only", id: "gallery_images_input", onchange: "previewGallery(event)" %>
      <div id="gallery-preview" class="hidden w-full mb-4">
        <div id="gallery-preview-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-2"></div>
      </div>
      <div id="gallery-upload-prompt">
        <svg class="mx-auto h-10 w-10 text-gray-300 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        <p class="text-sm text-gray-500">Click or drag and drop to add images</p>
        <p class="text-xs text-gray-400 mt-1">PNG, JPG, WEBP — select multiple files</p>
      </div>
    </label>
  </div>

  <%# Category & Tags %>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <div>
      <%= form.label :category_id, "Category", class: "block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2" %>
      <% if @categories.any? %>
        <div class="relative">
          <%= form.select :category_id,
            @categories.map { |c| [c.name, c.id] },
            { prompt: "Select a category…" },
            class: "w-full border border-gray-200 focus:border-gray-900 focus:outline-none focus:ring-0 px-3 py-2.5 text-sm bg-white appearance-none pr-8 transition-colors" %>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
        </div>
      <% else %>
        <div class="border border-dashed border-gray-200 px-3 py-2.5 text-sm text-gray-400">
          No categories.
          <%= link_to "Create one →", new_admin_category_path, class: "text-gray-700 underline", target: "_blank" %>
        </div>
      <% end %>
    </div>

    <div>
      <p class="block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2">Tags</p>
      <% if @tags.any? %>
        <div class="border border-gray-200 p-3 flex flex-wrap gap-x-4 gap-y-2 bg-white">
          <% @tags.each do |tag| %>
            <label class="flex items-center gap-2 cursor-pointer group">
              <input type="checkbox"
                name="article[tag_ids][]"
                value="<%= tag.id %>"
                <%= article.tag_ids.include?(tag.id) ? "checked" : "" %>
                class="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-1 focus:ring-gray-900 focus:ring-offset-0">
              <span class="text-sm text-gray-600 group-hover:text-gray-900 transition-colors"><%= tag.name %></span>
            </label>
          <% end %>
        </div>
        <input type="hidden" name="article[tag_ids][]" value="">
      <% else %>
        <div class="border border-dashed border-gray-200 px-3 py-2.5 text-sm text-gray-400">
          No tags.
          <%= link_to "Create some →", new_admin_tag_path, class: "text-gray-700 underline", target: "_blank" %>
        </div>
      <% end %>
    </div>
  </div>

  <%# Publish settings %>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-gray-100 pt-6">
    <div>
      <%= form.label :published_at, "Publish Date & Time", class: "block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2" %>
      <%= form.datetime_local_field :published_at,
        value: (article.published_at || Time.current).strftime("%Y-%m-%dT%H:%M"),
        class: "w-full border border-gray-200 focus:border-gray-900 focus:outline-none focus:ring-0 px-3 py-2.5 text-sm bg-white transition-colors" %>
      <p class="text-xs text-gray-400 mt-1">Defaults to today — change to schedule ahead</p>
    </div>
    <div class="flex items-start gap-3 md:pt-7">
      <%= form.check_box :featured,
        class: "mt-0.5 h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-1 focus:ring-gray-900" %>
      <div>
        <%= form.label :featured, "Featured article", class: "text-sm font-medium text-gray-700 cursor-pointer" %>
        <p class="text-xs text-gray-400 mt-0.5">Show in homepage hero section</p>
      </div>
    </div>
  </div>

  <%# Actions %>
  <div class="flex items-center justify-between border-t border-gray-200 pt-6">
    <%= link_to "Discard", admin_articles_path, class: "text-sm text-gray-400 hover:text-gray-700 transition-colors" %>
    <%= form.submit article.persisted? ? "Update Article" : "Publish Article",
      class: "px-6 py-2.5 text-sm font-semibold bg-gray-900 text-white hover:bg-gray-700 transition-colors cursor-pointer" %>
  </div>

<% end %>

<script>
  function previewImage(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      document.getElementById('preview-img').src = e.target.result;
      document.getElementById('image-preview').classList.remove('hidden');
      document.getElementById('upload-prompt').classList.add('hidden');
    };
    reader.readAsDataURL(file);
  }

  function previewGallery(event) {
    const files = event.target.files;
    if (!files.length) return;
    const grid = document.getElementById('gallery-preview-grid');
    grid.innerHTML = '';
    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'w-full h-20 object-cover border border-gray-200';
        grid.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
    document.getElementById('gallery-preview').classList.remove('hidden');
    document.getElementById('gallery-upload-prompt').classList.add('hidden');
  }

  const zone = document.getElementById('image-drop-zone');
  const input = document.getElementById('cover_image_input');
  if (zone && input) {
    zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('border-gray-900'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('border-gray-900'));
    zone.addEventListener('drop', (e) => {
      e.preventDefault(); zone.classList.remove('border-gray-900');
      input.files = e.dataTransfer.files;
      input.dispatchEvent(new Event('change'));
    });
  }

  const galleryZone = document.getElementById('gallery-drop-zone');
  const galleryInput = document.getElementById('gallery_images_input');
  if (galleryZone && galleryInput) {
    galleryZone.addEventListener('dragover', (e) => { e.preventDefault(); galleryZone.classList.add('border-gray-900'); });
    galleryZone.addEventListener('dragleave', () => galleryZone.classList.remove('border-gray-900'));
    galleryZone.addEventListener('drop', (e) => {
      e.preventDefault(); galleryZone.classList.remove('border-gray-900');
      galleryInput.files = e.dataTransfer.files;
      galleryInput.dispatchEvent(new Event('change'));
    });
  }
</script>
