<%= form_with(model: [:admin, article], multipart: true, class: "space-y-8") do |form| %>

  <% if article.errors.any? %>
    <div class="bg-red-50 border border-red-200 px-5 py-4">
      <p class="text-sm font-semibold text-red-700 mb-2">
        <%= pluralize(article.errors.count, "error") %> prevented this article from being saved:
      </p>
      <ul class="list-disc list-inside text-sm text-red-600 space-y-1">
        <% article.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# Title %>
  <div>
    <%= form.label :title, "Title", class: "block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2" %>
    <%= form.text_field :title,
      placeholder: "Enter article title…",
      class: "w-full font-serif text-2xl font-bold border-0 border-b-2 border-gray-200 focus:border-gray-900 focus:outline-none focus:ring-0 py-2 px-0 placeholder-gray-300 bg-transparent transition-colors" %>
  </div>

  <%# Excerpt %>
  <div>
    <%= form.label :excerpt, "Excerpt", class: "block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2" %>
    <%= form.text_area :excerpt, rows: 3,
      placeholder: "Short summary shown on cards and listings…",
      class: "w-full border border-gray-200 focus:border-gray-900 focus:outline-none focus:ring-0 p-3 text-sm leading-relaxed placeholder-gray-300 resize-none transition-colors" %>
  </div>

  <%# Body %>
  <div>
    <%= form.label :body, "Body", class: "block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2" %>
    <%= form.rich_text_area :body, class: "trix-admin" %>
  </div>

  <%# Images (first image = cover) %>
  <div>
    <p class="block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2">Images <span class="normal-case font-normal text-gray-400">— first image used as cover</span></p>

    <%# Existing (saved) images %>
    <% if article.persisted? && article.images.attached? %>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mb-4">
        <% article.images.each_with_index do |image, i| %>
          <div class="relative group border border-gray-200 overflow-hidden" id="saved-image-<%= image.id %>">
            <%= image_tag image, class: "w-full h-28 object-cover", id: "saved-img-#{image.id}" %>
            <% if i == 0 %>
              <span class="absolute bottom-1 left-1 bg-gray-900 text-white text-[10px] font-semibold px-1.5 py-0.5 leading-none">Cover</span>
            <% end %>
            <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
              <%# Replace button %>
              <label class="bg-white border border-gray-200 text-gray-500 hover:text-blue-600 hover:border-blue-300 transition-colors p-1 cursor-pointer" title="Replace image">
                <input type="file" name="article[replace_image][<%= image.id %>]" accept="image/*"
                  class="sr-only" data-replace-for="<%= image.id %>">
                <svg class="w-3.5 h-3.5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                </svg>
              </label>
              <%# Delete button %>
              <%= link_to purge_image_admin_article_path(article, image_id: image.id),
                class: "bg-white border border-gray-200 text-gray-500 hover:text-red-600 hover:border-red-300 transition-colors p-1",
                data: { turbo_method: :delete, turbo_confirm: "Remove this image?" } do %>
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

    <%# Selected-but-not-yet-saved preview (shown above the dropzone) %>
    <div id="gallery-new-preview" class="hidden mb-3">
      <p class="text-xs text-gray-500 font-medium mb-2">Selected for upload — hover to edit or remove:</p>
      <div id="gallery-new-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2"></div>
    </div>

    <%# Dropzone — clicking/dropping always adds to the selection %>
    <label class="flex items-center justify-center gap-4 border-2 border-dashed border-gray-200 hover:border-gray-400 transition-colors cursor-pointer px-6 py-5 bg-white"
           id="gallery-drop-zone">
      <%= form.file_field :images, multiple: true, name: "article[images][]", accept: "image/*",
        class: "sr-only", id: "gallery_images_input" %>
      <svg class="h-8 w-8 text-gray-300 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
          d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
      <div>
        <p class="text-sm text-gray-500">Click or drag and drop to add images</p>
        <p class="text-xs text-gray-400 mt-0.5">PNG, JPG, WEBP — select multiple at once</p>
      </div>
    </label>
  </div>

  <%# Author, Category & Tags %>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <%# Author %>
    <div class="md:col-span-2">
      <%= form.label :team_member_id, "Author", class: "block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2" %>
      <% if current_admin_user.role&.name == "Root Admin" %>
        <% team_members = TeamMember.order(:name) %>
        <% if team_members.any? %>
          <div class="relative">
            <%= form.select :team_member_id,
              team_members.map { |m| [m.name, m.id] },
              { prompt: "No author assigned…", include_blank: true },
              class: "w-full border border-gray-200 focus:border-gray-900 focus:outline-none focus:ring-0 px-3 py-2.5 text-sm bg-white appearance-none pr-8 transition-colors" %>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400">
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </div>
          </div>
        <% else %>
          <div class="border border-dashed border-gray-200 px-3 py-2.5 text-sm text-gray-400">
            No team members yet.
            <%= link_to "Add one →", new_admin_team_member_path, class: "text-gray-700 underline", target: "_blank" %>
          </div>
        <% end %>
      <% else %>
        <div class="border border-gray-200 px-3 py-2.5 text-sm text-gray-700 bg-gray-50 flex items-center justify-between">
          <span><%= article.author&.name || "No author assigned" %></span>
          <span class="text-xs text-gray-400">Only Root Admin can change this</span>
        </div>
      <% end %>
    </div>

    <div>
      <p class="block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2">Categories</p>
      <% if @categories.any? %>
        <div class="border border-gray-200 p-3 flex flex-wrap gap-x-4 gap-y-2 bg-white">
          <% @categories.each do |cat| %>
            <label class="flex items-center gap-2 cursor-pointer group">
              <input type="checkbox"
                name="article[category_ids][]"
                value="<%= cat.id %>"
                <%= article.category_ids.include?(cat.id) ? "checked" : "" %>
                class="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-1 focus:ring-gray-900 focus:ring-offset-0">
              <span class="text-sm text-gray-600 group-hover:text-gray-900 transition-colors"><%= cat.name %></span>
            </label>
          <% end %>
        </div>
        <input type="hidden" name="article[category_ids][]" value="">
      <% else %>
        <div class="border border-dashed border-gray-200 px-3 py-2.5 text-sm text-gray-400">
          No categories.
          <%= link_to "Create one →", new_admin_category_path, class: "text-gray-700 underline", target: "_blank" %>
        </div>
      <% end %>
    </div>

    <div>
      <p class="block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2">Tags</p>
      <% if @tags.any? %>
        <div class="border border-gray-200 p-3 flex flex-wrap gap-x-4 gap-y-2 bg-white">
          <% @tags.each do |tag| %>
            <label class="flex items-center gap-2 cursor-pointer group">
              <input type="checkbox"
                name="article[tag_ids][]"
                value="<%= tag.id %>"
                <%= article.tag_ids.include?(tag.id) ? "checked" : "" %>
                class="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-1 focus:ring-gray-900 focus:ring-offset-0">
              <span class="text-sm text-gray-600 group-hover:text-gray-900 transition-colors"><%= tag.name %></span>
            </label>
          <% end %>
        </div>
        <input type="hidden" name="article[tag_ids][]" value="">
      <% else %>
        <div class="border border-dashed border-gray-200 px-3 py-2.5 text-sm text-gray-400">
          No tags.
          <%= link_to "Create some →", new_admin_tag_path, class: "text-gray-700 underline", target: "_blank" %>
        </div>
      <% end %>
    </div>
  </div>

  <%# Publish settings %>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-gray-100 pt-6">
    <div>
      <%= form.label :published_at, "Publish Date & Time", class: "block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-2" %>
      <%= form.datetime_local_field :published_at,
        value: (article.published_at || Time.current).strftime("%Y-%m-%dT%H:%M"),
        class: "w-full border border-gray-200 focus:border-gray-900 focus:outline-none focus:ring-0 px-3 py-2.5 text-sm bg-white transition-colors" %>
      <p class="text-xs text-gray-400 mt-1">Defaults to today — change to schedule ahead</p>
    </div>
    <div class="flex items-start gap-3 md:pt-7">
      <%= form.check_box :featured,
        class: "mt-0.5 h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-1 focus:ring-gray-900" %>
      <div>
        <%= form.label :featured, "Featured article", class: "text-sm font-medium text-gray-700 cursor-pointer" %>
        <p class="text-xs text-gray-400 mt-0.5">Show in homepage hero section</p>
      </div>
    </div>
  </div>

  <%# Actions %>
  <div class="flex items-center justify-between border-t border-gray-200 pt-6">
    <%= link_to "Discard", admin_articles_path, class: "text-sm text-gray-400 hover:text-gray-700 transition-colors" %>
    <%= form.submit article.persisted? ? "Update Article" : "Publish Article",
      class: "px-6 py-2.5 text-sm font-semibold bg-gray-900 text-white hover:bg-gray-700 transition-colors cursor-pointer" %>
  </div>

<% end %>

<script>
  (function () {
    var fileItems = [];
    var nextId    = 0;

    var PENCIL = '<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>';
    var CROSS  = '<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>';

    function addFiles(files) {
      Array.from(files).forEach(function (f) {
        if (!f.type.startsWith('image/')) return;
        fileItems.push({ id: nextId++, file: f, url: URL.createObjectURL(f) });
      });
      render(); sync();
    }

    function removeItem(id) {
      var idx = fileItems.findIndex(function (x) { return x.id === id; });
      if (idx === -1) return;
      URL.revokeObjectURL(fileItems[idx].url);
      fileItems.splice(idx, 1);
      render(); sync();
    }

    function replaceItem(id) {
      var picker = document.createElement('input');
      picker.type = 'file'; picker.accept = 'image/*';
      picker.onchange = function () {
        if (!picker.files[0]) return;
        var idx = fileItems.findIndex(function (x) { return x.id === id; });
        if (idx === -1) return;
        URL.revokeObjectURL(fileItems[idx].url);
        fileItems[idx].file = picker.files[0];
        fileItems[idx].url  = URL.createObjectURL(picker.files[0]);
        render(); sync();
      };
      picker.click();
    }

    function sync() {
      var dt    = new DataTransfer();
      var input = document.getElementById('gallery_images_input');
      fileItems.forEach(function (x) { dt.items.add(x.file); });
      if (input) input.files = dt.files;
    }

    function render() {
      var grid    = document.getElementById('gallery-new-grid');
      var wrapper = document.getElementById('gallery-new-preview');
      if (!grid) return;
      grid.innerHTML = '';

      fileItems.forEach(function (item) {
        var div = document.createElement('div');
        div.className = 'relative group border border-gray-200 overflow-hidden';
        div.innerHTML =
          '<img src="' + item.url + '" class="w-full h-24 object-cover" alt="">' +
          '<div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors pointer-events-none"></div>' +
          '<div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">' +
            '<button type="button" data-action="edit" data-id="' + item.id + '" title="Replace image" ' +
              'class="bg-white border border-gray-200 text-gray-500 hover:text-blue-600 hover:border-blue-300 p-1 transition-colors">' +
              PENCIL + '</button>' +
            '<button type="button" data-action="remove" data-id="' + item.id + '" title="Remove" ' +
              'class="bg-white border border-gray-200 text-gray-500 hover:text-red-600 hover:border-red-300 p-1 transition-colors">' +
              CROSS + '</button>' +
          '</div>';

        div.querySelectorAll('button').forEach(function (btn) {
          btn.addEventListener('click', function (e) {
            e.preventDefault(); e.stopPropagation();
            var id = parseInt(btn.dataset.id);
            if (btn.dataset.action === 'remove') removeItem(id);
            else replaceItem(id);
          });
        });

        grid.appendChild(div);
      });

      if (wrapper) wrapper.classList.toggle('hidden', fileItems.length === 0);
    }

    // File input — accumulates, never replaces
    var input = document.getElementById('gallery_images_input');
    if (input) {
      input.addEventListener('change', function () {
        var captured = Array.from(input.files); // capture before resetting
        input.value = '';  // reset so the same file can be re-picked
        addFiles(captured); // sync() inside sets input.files = dt.files
      });
    }

    // Drag-and-drop zone
    var zone = document.getElementById('gallery-drop-zone');
    if (zone && input) {
      zone.addEventListener('dragover',  function (e) { e.preventDefault(); zone.classList.add('border-gray-900'); });
      zone.addEventListener('dragleave', function ()  { zone.classList.remove('border-gray-900'); });
      zone.addEventListener('drop', function (e) {
        e.preventDefault(); zone.classList.remove('border-gray-900');
        addFiles(e.dataTransfer.files);
      });
    }
  })();

  // ── Replace saved (database) images ──────────────────────────
  document.querySelectorAll('input[data-replace-for]').forEach(function (inp) {
    inp.addEventListener('change', function () {
      if (!inp.files[0]) return;
      var id  = inp.dataset.replaceFor;
      var img = document.getElementById('saved-img-' + id);
      if (img) img.src = URL.createObjectURL(inp.files[0]);
      var container = document.getElementById('saved-image-' + id);
      if (container && !container.querySelector('.replace-badge')) {
        var badge = document.createElement('span');
        badge.className = 'replace-badge absolute bottom-1 left-1 bg-blue-600 text-white text-[10px] font-semibold px-1.5 py-0.5 leading-none';
        badge.textContent = 'Replacing…';
        container.appendChild(badge);
      }
    });
  });
</script>
