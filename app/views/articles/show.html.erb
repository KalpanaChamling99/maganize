<%# ── Hero image ──────────────────────────────────────────── %>
<% if @article.images.attached? %>
  <div class="relative h-[480px] -mx-4 sm:-mx-6 mb-10 overflow-hidden">
    <%= image_tag @article.images.first, alt: @article.title,
      class: "w-full h-full object-cover" %>
    <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent"></div>

    <%# Overlaid meta on image %>
    <div class="absolute bottom-0 left-0 right-0 px-6 sm:px-10 pb-8">
      <div class="max-w-3xl">
        <div class="flex flex-wrap items-center gap-2 mb-4">
          <% if @article.category %>
            <%= link_to @article.category.name, category_path(@article.category),
              class: "text-xs font-bold px-3 py-1 bg-red-500 text-white uppercase tracking-widest hover:bg-red-600 transition-colors" %>
          <% end %>
          <% @article.tags.each do |tag| %>
            <%= link_to "##{tag.name}", tag_path(tag),
              class: "text-xs font-semibold px-2 py-0.5 bg-white/20 text-white uppercase tracking-wide border border-white/30 hover:bg-white/30 transition-colors" %>
          <% end %>
        </div>
        <h1 class="font-heading text-3xl sm:text-4xl lg:text-5xl font-bold text-white leading-tight mb-4">
          <%= @article.title %>
        </h1>
        <div class="flex items-center gap-4 text-sm text-white/70">
          <%= lucide_icon "calendar", class: "w-4 h-4 shrink-0 text-white/60" %>
          <time><%= @article.published_at.strftime("%B %-d, %Y") %></time>
          <% if @article.author %>
            <span class="text-white/40">·</span>
            <%= lucide_icon "user", class: "w-4 h-4 shrink-0 text-white/60" %>
            <%= link_to @article.author.name, team_member_path(@article.author),
              class: "hover:text-white transition-colors" %>
          <% end %>
          <span class="text-white/40">·</span>
          <%= lucide_icon "clock", class: "w-4 h-4 shrink-0 text-white/60" %>
          <span><%= [(@article.body.to_plain_text.split.size / 200.0).ceil, 1].max %> min read</span>
        </div>
      </div>
    </div>
  </div>
<% else %>
  <%# No image: plain header block %>
  <div class="mb-10 pb-8 border-b border-gray-200">
    <div class="flex flex-wrap items-center gap-2 mb-4">
      <% if @article.category %>
        <%= link_to @article.category.name, category_path(@article.category),
          class: "text-xs font-bold px-3 py-1 bg-red-500 text-white uppercase tracking-widest" %>
      <% end %>
      <% @article.tags.each do |tag| %>
        <%= link_to "##{tag.name}", tag_path(tag),
          class: "text-xs font-semibold px-2 py-0.5 border border-gray-300 text-gray-500 uppercase tracking-wide hover:bg-gray-900 hover:text-white transition-colors" %>
      <% end %>
    </div>
    <h1 class="font-heading text-3xl sm:text-4xl lg:text-5xl font-bold leading-tight mb-4">
      <%= @article.title %>
    </h1>
    <div class="flex items-center gap-4 text-sm text-gray-400">
      <%= lucide_icon "calendar", class: "w-4 h-4 shrink-0" %>
      <time><%= @article.published_at.strftime("%B %-d, %Y") %></time>
      <% if @article.author %>
        <span>·</span>
        <%= lucide_icon "user", class: "w-4 h-4 shrink-0" %>
        <%= link_to @article.author.name, team_member_path(@article.author),
          class: "hover:text-gray-700 transition-colors" %>
      <% end %>
      <span>·</span>
      <%= lucide_icon "clock", class: "w-4 h-4 shrink-0" %>
      <span><%= [(@article.body.to_plain_text.split.size / 200.0).ceil, 1].max %> min read</span>
    </div>
  </div>
<% end %>

<%# ── Article body ─────────────────────────────────────────── %>
<div class="max-w-3xl mx-auto">

  <%# Excerpt / standfirst %>
  <% if @article.excerpt.present? %>
    <p class="text-xl text-gray-600 leading-relaxed mb-8 pb-8 border-b border-gray-200">
      <%= @article.excerpt %>
    </p>
  <% end %>

  <%# Body content %>
  <div class="prose prose-lg prose-gray max-w-none
    prose-headings:font-heading prose-headings:font-bold
    prose-h2:text-2xl prose-h2:mt-10 prose-h2:mb-4
    prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-3
    prose-p:leading-relaxed prose-p:text-gray-700 prose-p:mb-5
    prose-a:text-red-600 prose-a:no-underline hover:prose-a:underline
    prose-blockquote:border-l-4 prose-blockquote:border-red-500
    prose-blockquote:pl-4 prose-blockquote:italic prose-blockquote:text-gray-500
    prose-img:rounded prose-img:shadow-md">
    <%= @article.body %>
  </div>

  <%# ── Gallery carousel (skip first — used as cover) ────────── %>
  <% if @article.images.count > 1 %>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">

    <style>
      .article-gallery-swiper { padding-bottom: 40px !important; }
      .article-gallery-swiper .swiper-pagination-bullet-active { background: #111827; }
      .article-gallery-swiper .swiper-button-next,
      .article-gallery-swiper .swiper-button-prev {
        color: #111827;
        background: white;
        border: 1px solid #e5e7eb;
        width: 36px;
        height: 36px;
        border-radius: 0;
        top: 40%;
      }
      .article-gallery-swiper .swiper-button-next::after,
      .article-gallery-swiper .swiper-button-prev::after { font-size: 14px; font-weight: 700; }
    </style>

    <div class="mt-10 pt-8 border-t border-gray-200">
      <p class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-4">Gallery</p>

      <div class="swiper article-gallery-swiper">
        <div class="swiper-wrapper">
          <% @article.images[1..].each do |image| %>
            <div class="swiper-slide">
              <%= image_tag image, alt: @article.title,
                class: "w-full h-72 object-cover border border-gray-100" %>
            </div>
          <% end %>
        </div>
        <div class="swiper-pagination"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
      new Swiper(".article-gallery-swiper", {
        loop: true,
        slidesPerView: 1,
        spaceBetween: 12,
        pagination: { el: ".swiper-pagination", clickable: true },
        navigation: { nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev" },
        breakpoints: {
          640:  { slidesPerView: 2 },
          1024: { slidesPerView: 3 }
        }
      });
    </script>
  <% end %>

  <%# ── Tags ──────────────────────────────────────────────── %>
  <% if @article.tags.any? %>
    <div class="mt-10 pt-8 border-t border-gray-200">
      <p class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-3">Tags</p>
      <div class="flex flex-wrap gap-2">
        <% @article.tags.each do |tag| %>
          <%= link_to "##{tag.name}", tag_path(tag),
            class: "text-sm px-3 py-1.5 border border-gray-200 hover:bg-gray-900 hover:text-white transition-all" %>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# ── Author card ─────────────────────────────────────────── %>
  <% if @article.author %>
    <% author = @article.author %>
    <div class="mt-10 pt-8 border-t border-gray-200">
      <p class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-4">Written by</p>
      <div class="flex items-start gap-4">
        <%= link_to team_member_path(author) do %>
          <div class="w-14 h-14 rounded-full overflow-hidden bg-gray-100 flex items-center justify-center text-gray-500 font-heading font-bold text-lg shrink-0 ring-2 ring-gray-200">
            <% if author.avatar.attached? %>
              <%= image_tag author.avatar, class: "w-full h-full object-cover" %>
            <% else %>
              <%= author.name.split.map(&:first).first(2).join %>
            <% end %>
          </div>
        <% end %>
        <div>
          <%= link_to author.name, team_member_path(author),
            class: "font-heading text-lg font-bold text-gray-900 hover:text-red-600 transition-colors" %>
          <% if author.role.present? %>
            <p class="text-xs uppercase tracking-widest text-gray-400 mt-0.5"><%= author.role %></p>
          <% end %>
          <% if author.bio.present? %>
            <p class="text-sm text-gray-500 leading-relaxed mt-2"><%= author.bio %></p>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <%# ── Comments ──────────────────────────────────────────────── %>
  <div class="mt-10 pt-8 border-t border-gray-200" id="comments">

    <div class="flex items-center gap-3 mb-6">
      <span class="text-xs font-semibold tracking-widest uppercase text-gray-400">Comments</span>
      <span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 font-semibold"><%= @article.comments.count %></span>
      <div class="flex-1 h-px bg-gray-200"></div>
    </div>

    <%# Existing comments %>
    <% if @article.comments.any? %>
      <div class="space-y-6 mb-10">
        <% @article.comments.order(created_at: :asc).each do |comment| %>
          <div class="flex gap-4">
            <div class="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center shrink-0 text-xs font-bold text-gray-600 uppercase select-none">
              <%= comment.name.split.map(&:first).first(2).join %>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex flex-wrap items-baseline gap-2 mb-1">
                <span class="text-sm font-semibold text-gray-900"><%= comment.name %></span>
                <span class="text-xs text-gray-400"><%= comment.created_at.strftime("%B %-d, %Y · %-I:%M %p") %></span>
              </div>
              <p class="text-sm text-gray-600 leading-relaxed"><%= comment.body %></p>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-sm text-gray-400 italic mb-8">No comments yet. Be the first to share your thoughts.</p>
    <% end %>

    <%# Flash for comment errors %>
    <% if flash[:alert].present? %>
      <div class="bg-red-50 border border-red-200 text-red-700 text-sm px-4 py-3 mb-4">
        <%= flash[:alert] %>
      </div>
    <% end %>

    <%# Comment form — admin users only %>
    <% if current_admin_user %>
      <div id="comment-form" class="bg-gray-50 border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-5">
          <p class="text-xs font-semibold tracking-widest uppercase text-gray-500">Leave a comment</p>
          <span class="inline-flex items-center gap-1.5 text-xs text-gray-500">
            <span class="w-2 h-2 rounded-full bg-green-400 shrink-0"></span>
            Signed in as <strong class="text-gray-800"><%= current_admin_user.name %></strong>
            <% if current_admin_user.role %>
              <span class="text-gray-400">&middot; <%= current_admin_user.role.name %></span>
            <% end %>
          </span>
        </div>

        <%= form_with url: article_comments_path(@article), class: "space-y-4" do |f| %>
          <div>
            <%= f.label :body, "Comment *", class: "block text-xs font-semibold tracking-widest uppercase text-gray-500 mb-1.5" %>
            <%= f.text_area :body, rows: 4, placeholder: "Share your thoughts…", required: true,
              class: "w-full border border-gray-200 focus:border-gray-900 focus:outline-none focus:ring-0 p-3 text-sm leading-relaxed placeholder-gray-300 resize-none transition-colors" %>
          </div>
          <%= f.submit "Post Comment",
            class: "px-6 py-2.5 text-sm font-semibold bg-gray-900 text-white hover:bg-gray-700 transition-colors cursor-pointer" %>
        <% end %>
      </div>
    <% else %>
      <div class="border border-dashed border-gray-200 px-6 py-8 text-center">
        <p class="text-sm text-gray-500 mb-3">Sign in to join the conversation.</p>
        <%= link_to "Sign in", admin_login_path,
          class: "inline-block px-5 py-2 text-sm font-semibold bg-gray-900 text-white hover:bg-gray-700 transition-colors" %>
      </div>
    <% end %>

  </div>

  <%# ── Back nav ────────────────────────────────────────────── %>
  <div class="mt-10 pt-6 border-t border-gray-200 flex items-center justify-between text-sm text-gray-400">
    <%= link_to "← Back to articles", articles_path, class: "hover:text-gray-900 transition-colors" %>
    <% if @article.category %>
      <%= link_to "More in #{@article.category.name} →", category_path(@article.category),
        class: "hover:text-gray-900 transition-colors" %>
    <% end %>
  </div>
</div>

<%# ── Related articles ─────────────────────────────────────── %>
<% if @related_articles.any? %>
  <div class="mt-16 pt-10 border-t border-gray-200">
    <div class="flex items-center gap-3 mb-8">
      <span class="text-xs font-semibold tracking-widest uppercase text-gray-400">Related Articles</span>
      <div class="flex-1 h-px bg-gray-200"></div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <% @related_articles.each do |article| %>
        <%= render "articles/article_card", article: article,
          image_height: "h-48",
          tag_limit: 0,
          title_size: "text-base",
          card_padding: "p-4",
          date_color: "text-gray-400",
          placeholder_icon_size: "w-8 h-8",
          show_excerpt: false %>
      <% end %>
    </div>
  </div>
<% end %>
